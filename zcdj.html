<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>çŸ­å‰§çŒæ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            width: 30px; /* è°ƒæ•´å®½åº¦ */
            height: 30px; /* è°ƒæ•´é«˜åº¦ */
            margin-right: 10px;
            cursor: pointer;
            object-fit: contain; /* ç¡®ä¿å›¾ç‰‡å®Œæ•´æ˜¾ç¤º */
        }

        .search-container {
            flex: 1;
            max-width: 500px;
            margin: 0 15px;
        }

        .search-input {
            width: 100%;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
        }

        .header-icons {
            display: flex;
            gap: 15px;
        }

        .header-icon {
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .carousel {
            width: 100%;
            height: 200px;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .carousel img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .section {
            margin: 30px 0;
        }

        .section-title {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 15px;
        }

        .movies-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* ä¸€è¡Œ3ä¸ª */
            gap: 15px;
        }

        .movie-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease;
            position: relative; /* ä¸ºæ”¶è—å›¾æ ‡å®šä½ */
        }

        .movie-card:hover {
            transform: translateY(-2px);
        }

        .movie-cover {
            width: 100%;
            height: 200px; /* å›ºå®šé«˜åº¦ï¼Œä¸å¡ç‰‡ä¸€è‡´ */
            object-fit: cover; /* å¡«æ»¡ï¼Œè£å‰ªè¾¹ç¼˜ */
            display: block;
        }

        .movie-info {
            padding: 10px;
        }

        .movie-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .movie-meta {
            color: #777;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .movie-intro {
            color: #999;
            font-size: 0.8rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* æ–°å¢ï¼šæ”¶è—å›¾æ ‡æ ·å¼ */
        .favorite-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 18px;
            color: #ccc;
            cursor: pointer;
            z-index: 10;
        }

        .favorite-icon.favorited {
            color: #ff6b6b;
        }

        /* æœç´¢ç»“æœé¡µé¢ */
        .search-results-page {
            display: none;
        }

        .search-results-header {
            display: flex;
            align-items: center;
            margin: 20px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .search-results-header h2 {
            margin-right: 15px;
            font-size: 1.1rem;
        }

        .search-results-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        /* æ–°å¢ï¼šæœç´¢ç»“æœæ ‡ç­¾é¡µ */
        .search-source-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .search-source-tab {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
        }

        .search-source-tab.active {
            color: #ff6b6b;
            border-bottom-color: #ff6b6b;
        }

        .source-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none; /* é»˜è®¤éšè—ï¼Œé€šè¿‡JSæ§åˆ¶æ˜¾ç¤º */
        }

        .source-section.active {
            display: block;
        }

        .source-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .source-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-right: 10px;
        }

        .source-count {
            font-size: 0.8rem;
            color: #777;
        }

        .source-movies-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* ä¸€è¡Œ3ä¸ª */
            gap: 15px;
        }

        /* æ’­æ”¾é¡µé¢ */
        .video-page {
            display: none;
        }

        .video-player-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto 20px;
            background: black;
            border-radius: 8px;
            overflow: hidden;
        }

        .video-player {
            width: 100%;
            height: 450px;
            background: #000;
        }

        .video-info {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .video-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .video-meta {
            color: #777;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .episodes-list {
            margin: 20px 0;
        }

        .episodes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .episodes-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }

        .episodes-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
            scrollbar-width: thin;
            scrollbar-color: #ccc #f5f5f5;
        }

        .episode-item {
            min-width: 80px;
            padding: 10px 15px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .episode-item:hover {
            background: #eee;
        }

        .episode-item.active {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #777;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .movies-grid,
            .source-movies-grid {
                grid-template-columns: 1fr;
            }

            .video-player {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨ -->
    <div class="header">
        <img class="logo" id="logo" src="1.png" alt="Logo">
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢çŸ­å‰§åç§°...">
        </div>
        <div class="header-icons">
            <div class="header-icon" id="historyIcon">ğŸ•’</div>
            <div class="header-icon" id="downloadIcon">â­ï¸</div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="container" id="mainContent">
        <!-- è½®æ’­å›¾ -->
        <div class="carousel" id="carousel">
            <img src="IMG_20251004_152412.jpg" alt="è½®æ’­å›¾">
        </div>

        <!-- æ¨èå†…å®¹ -->
        <div class="section">
            <div class="section-title">æ¨è</div>
            <div class="movies-grid" id="recommendedMovies">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- æœç´¢ç»“æœé¡µé¢ -->
    <div class="container search-results-page" id="searchResultsPage">
        <div class="search-results-header">
            <h2>æœç´¢ç»“æœ</h2>
            <div class="search-results-count" id="searchCount">å…± 0 æ¡ç»“æœ</div>
        </div>

        <!-- æœç´¢ç»“æœæ ‡ç­¾é¡µ -->
        <div class="search-source-tabs">
            <div class="search-source-tab active" data-source="hongguo">çº¢æœ</div>
            <div class="search-source-tab" data-source="hema">æ²³é©¬</div>
        </div>

        <div class="search-results-content" id="searchResultsContent">
            <!-- çº¢æœ -->
            <div class="source-section active" id="sourceSectionHongguo">
                <div class="source-header">
                    <div class="source-name">çº¢æœ</div>
                    <div class="source-count" id="hongguoCount">å…± 0 éƒ¨</div>
                </div>
                <div class="source-movies-grid" id="hongguoGrid">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
            <!-- æ²³é©¬ -->
            <div class="source-section" id="sourceSectionHema">
                <div class="source-header">
                    <div class="source-name">æ²³é©¬</div>
                    <div class="source-count" id="hemaCount">å…± 0 éƒ¨</div>
                </div>
                <div class="source-movies-grid" id="hemaGrid">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- è§†é¢‘æ’­æ”¾é¡µé¢ -->
    <div class="container video-page" id="videoPage">
        <div class="video-player-container">
            <video class="video-player" id="videoPlayer" controls preload="metadata">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
            </video>
        </div>

        <div class="video-info">
            <h1 class="video-title" id="videoTitle">è§†é¢‘æ ‡é¢˜</h1>
            <div class="video-meta" id="videoMeta">ç‚¹å‡»é‡ 0 | 2025 çˆ±æƒ…,åŠ¨ç”»,å¥‡å¹»,å†’é™©</div>
        </div>

        <div class="episodes-list">
            <div class="episodes-header">
                <div class="episodes-title">é€‰é›†</div>
                <div class="episodes-more" id="episodeCount">æ›´æ–°è‡³1é›† ></div>
            </div>
            <div class="episodes-scroll" id="episodesScroll">
                <!-- å‰§é›†åˆ—è¡¨ä¼šåŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
            </div>
        </div>
    </div>

    <!-- å…³äºæˆ‘å¼¹çª— -->
    <div class="modal" id="aboutModal">
        <div class="modal-content">
            <span class="modal-close" id="closeAboutModal">&times;</span>
            <h2>å…³äºæˆ‘</h2>
            <p>æ„Ÿè°¢ä½¿ç”¨ç”±zcå¼€å‘çš„çŸ­å‰§çŒæ‰‹åº”ç”¨ï¼</p>
            <p>æä¾›æµ·é‡ä¼˜è´¨çŸ­å‰§èµ„æºï¼Œæ”¯æŒç•ªèŒ„/è¥¿ç“œ/çº¢æœ/è›‹èŠ±/å¸¸è¯»/æ‚Ÿç©º/æ²³é©¬/ç¹èŠ±/ç‚¹ä¼— è¿™äº›å¹³å°</p>
            <p>æŒç»­æ›´æ–°æœ€æ–°çŸ­å‰§æ— å¹¿å‘Šå†…å®¹ï¼ä¸ºä½ å¸¦æ¥æœ€ä½³è§‚çœ‹ä½“éªŒï¼</p>
        </div>
    </div>

    <!-- æ”¶è—å¼¹çª— -->
    <div class="modal" id="favoritesModal">
        <div class="modal-content">
            <span class="modal-close" id="closeFavoritesModal">&times;</span>
            <h2>æ”¶è—åˆ—è¡¨</h2>
            <div id="favoritesContent">æš‚æ— æ”¶è—å†…å®¹</div>
        </div>
    </div>

    <!-- å†å²è§‚çœ‹å¼¹çª— -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <span class="modal-close" id="closeHistoryModal">&times;</span>
            <h2>å†å²è§‚çœ‹</h2>
            <div id="historyContent">æš‚æ— å†å²è®°å½•</div>
        </div>
    </div>

    <script>
        class ShortFilmSearch {
            constructor() {
                this.currentPage = 1;
                this.currentKeyword = '';
                this.currentBookId = '';
                this.currentVideoId = '';
                this.searchResults = { hongguo: [], hema: [] };
                this.favorites = JSON.parse(localStorage.getItem('favorites')) || [];
                this.history = JSON.parse(localStorage.getItem('history')) || [];
                this.currentEpisodeIndex = 0;
                this.episodes = [];
                this.currentQuality = '1080P';
                this.autoPlay = true;
                
              
                this.loadingHongguo = false;
                this.loadingHema = false;
                this.hasMoreHongguo = true;
                this.hasMoreHema = true;
                
             
                this.currentSource = 'hongguo';
                
                this.initializeElements();
                this.bindEvents();
                this.loadRecommendedContent();
            }

            initializeElements() {
                this.logo = document.getElementById('logo');
                this.searchInput = document.getElementById('searchInput');
                this.historyIcon = document.getElementById('historyIcon');
                this.downloadIcon = document.getElementById('downloadIcon');
                this.carousel = document.getElementById('carousel');
                this.recommendedMovies = document.getElementById('recommendedMovies');
                
                this.mainContent = document.getElementById('mainContent');
                this.searchResultsPage = document.getElementById('searchResultsPage');
                this.videoPage = document.getElementById('videoPage');
                
                this.searchResultsContent = document.getElementById('searchResultsContent');
                this.searchCount = document.getElementById('searchCount');
                
           
                this.searchSourceTabs = document.querySelectorAll('.search-source-tab');
                this.sourceSectionHongguo = document.getElementById('sourceSectionHongguo');
                this.sourceSectionHema = document.getElementById('sourceSectionHema');
                this.hongguoGrid = document.getElementById('hongguoGrid');
                this.hemaGrid = document.getElementById('hemaGrid');
                this.hongguoCount = document.getElementById('hongguoCount');
                this.hemaCount = document.getElementById('hemaCount');
                
                this.videoPlayer = document.getElementById('videoPlayer');
                this.videoTitle = document.getElementById('videoTitle');
                this.videoMeta = document.getElementById('videoMeta');
                this.episodesScroll = document.getElementById('episodesScroll');
                this.episodeCount = document.getElementById('episodeCount');
                
               
                this.aboutModal = document.getElementById('aboutModal');
                this.closeAboutModal = document.getElementById('closeAboutModal');
                
                this.favoritesModal = document.getElementById('favoritesModal');
                this.historyModal = document.getElementById('historyModal');
                this.closeFavoritesModal = document.getElementById('closeFavoritesModal');
                this.closeHistoryModal = document.getElementById('closeHistoryModal');
            }

            bindEvents() {
               
                if (this.logo) this.logo.addEventListener('click', function() { this.openModal('about'); }.bind(this));
                if (this.searchInput) this.searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleSearch();
                });
                if (this.historyIcon) this.historyIcon.addEventListener('click', () => this.openModal('history'));
                if (this.downloadIcon) this.downloadIcon.addEventListener('click', () => this.openModal('favorites'));
                
                // æœç´¢ç»“æœæ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
                this.searchSourceTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.searchSourceTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        const source = tab.dataset.source;
                        this.currentSource = source; // æ›´æ–°å½“å‰æ¥å£
                        this.showSourceTab(source);
                    });
                });
                
                // å…³äºæˆ‘å¼¹çª—å…³é—­äº‹ä»¶
                if (this.closeAboutModal) this.closeAboutModal.addEventListener('click', () => this.closeModal('about'));
                
                // æ»šåŠ¨åŠ è½½äº‹ä»¶
                window.addEventListener('scroll', this.handleScroll.bind(this));
                
                // è§†é¢‘æ’­æ”¾é”™è¯¯å¤„ç†
                if (this.videoPlayer) this.videoPlayer.addEventListener('error', (e) => {
                    console.error('è§†é¢‘æ’­æ”¾é”™è¯¯:', e);
                    alert('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–æ¢æº');
                });
                
                // è§†é¢‘æ’­æ”¾å®Œæˆäº‹ä»¶ - ç”¨äºè‡ªåŠ¨è¿æ’­
                if (this.videoPlayer) this.videoPlayer.addEventListener('ended', () => {
                    if (this.autoPlay && this.episodes.length > 0) {
                        this.playNextEpisode();
                    }
                });
                
                // å¼¹çª—å…³é—­äº‹ä»¶
                if (this.closeFavoritesModal) this.closeFavoritesModal.addEventListener('click', () => this.closeModal('favorites'));
                if (this.closeHistoryModal) this.closeHistoryModal.addEventListener('click', () => this.closeModal('history'));
            }

            openModal(type) {
                switch(type) {
                    case 'about':
                        if (this.aboutModal) this.aboutModal.style.display = 'flex';
                        break;
                    case 'favorites':
                        this.displayFavorites();
                        if (this.favoritesModal) this.favoritesModal.style.display = 'flex';
                        break;
                    case 'history':
                        this.displayHistory();
                        if (this.historyModal) this.historyModal.style.display = 'flex';
                        break;
                }
            }

            closeModal(type) {
                switch(type) {
                    case 'about':
                        if (this.aboutModal) this.aboutModal.style.display = 'none';
                        break;
                    case 'favorites':
                        if (this.favoritesModal) this.favoritesModal.style.display = 'none';
                        break;
                    case 'history':
                        if (this.historyModal) this.historyModal.style.display = 'none';
                        break;
                }
            }

            // æ»šåŠ¨åŠ è½½å¤„ç†å‡½æ•°
            handleScroll() {
                if (this.searchResultsPage.style.display !== 'block') return; // åªåœ¨æœç´¢ç»“æœé¡µæ‰§è¡Œ

                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const windowHeight = window.innerHeight;
                const documentHeight = document.documentElement.scrollHeight;

                if (scrollTop + windowHeight >= documentHeight - 100) { // è·ç¦»åº•éƒ¨100pxæ—¶è§¦å‘
                    const activeSource = this.currentSource; // ä½¿ç”¨å½“å‰é€‰ä¸­çš„æ¥å£
                    if (activeSource === 'hongguo' && this.hasMoreHongguo && !this.loadingHongguo) {
                        this.loadMoreResults('hongguo');
                    } else if (activeSource === 'hema' && this.hasMoreHema && !this.loadingHema) {
                        this.loadMoreResults('hema');
                    }
                }
            }

            getActiveSource() {
                // ä¼˜å…ˆä½¿ç”¨ this.currentSource
                return this.currentSource;
            }

            showSourceTab(source) {
                if (source === 'hongguo') {
                    this.sourceSectionHongguo.classList.add('active');
                    this.sourceSectionHema.classList.remove('active');
                } else if (source === 'hema') {
                    this.sourceSectionHema.classList.add('active');
                    this.sourceSectionHongguo.classList.remove('active');
                }
                this.currentSource = source; // æ›´æ–°å½“å‰æ¥å£
            }

            async handleSearch() {
                const keyword = this.searchInput?.value.trim();
                if (!keyword) return;
                
                this.currentKeyword = keyword;
                this.searchResults = { hongguo: [], hema: [] };
                this.currentPage = 1; // é‡ç½®é¡µç 
                this.hasMoreHongguo = true;
                this.hasMoreHema = true;
                this.loadingHongguo = false;
                this.loadingHema = false;
                
                // æ˜¾ç¤ºåŠ è½½ä¸­
                this.hongguoGrid.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
                this.hemaGrid.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
                
                // åŒæ—¶è¯·æ±‚ä¸¤ä¸ªæ¥å£çš„ç¬¬ä¸€é¡µ
                await Promise.all([
                    this.loadSearchResults('hongguo', 1),
                    this.loadSearchResults('hema', 1)
                ]);
                
                // åˆ‡æ¢åˆ°æœç´¢ç»“æœé¡µé¢
                if (this.mainContent) this.mainContent.style.display = 'none';
                if (this.searchResultsPage) this.searchResultsPage.style.display = 'block';
                if (this.videoPage) this.videoPage.style.display = 'none';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            async loadSearchResults(source, page) {
                if (source === 'hongguo') {
                    this.loadingHongguo = true;
                } else if (source === 'hema') {
                    this.loadingHema = true;
                }

                try {
                
                    let apiUrl;
                    if (source === 'hongguo') {
                        apiUrl = `https://api.cenguigui.cn/api/duanju/api.php?name=${encodeURIComponent(this.currentKeyword)}&page=${page}`;
                    } else if (source === 'hema') {
                        apiUrl = `https://api.cenguigui.cn/api/duanju/hema.php?name=${encodeURIComponent(this.currentKeyword)}&page=${page}`;
                    }

                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        // å»é‡é€»è¾‘
                        const newResults = data.data.filter(newItem => 
                            !this.searchResults[source].some(existingItem => existingItem.book_id === newItem.book_id)
                        );
                        this.searchResults[source] = [...this.searchResults[source], ...newResults];
                        
                        if (newResults.length === 0) { // å¦‚æœæ²¡æœ‰æ–°æ•°æ®ï¼Œè¯´æ˜æ²¡æœ‰æ›´å¤šäº†
                            if (source === 'hongguo') this.hasMoreHongguo = false;
                            if (source === 'hema') this.hasMoreHema = false;
                        }
                        this.displaySearchResults(source);
                    } else {
                        if (source === 'hongguo') this.hasMoreHongguo = false;
                        if (source === 'hema') this.hasMoreHema = false;
                    }
                } catch (error) {
                    console.error(`åŠ è½½${source}ç»“æœå¤±è´¥:`, error);
                    if (source === 'hongguo') this.hasMoreHongguo = false;
                    if (source === 'hema') this.hasMoreHema = false;
                } finally {
                    if (source === 'hongguo') {
                        this.loadingHongguo = false;
                    } else if (source === 'hema') {
                        this.loadingHema = false;
                    }
                }
            }

            displaySearchResults(source) {
                const grid = source === 'hongguo' ? this.hongguoGrid : this.hemaGrid;
                const countElement = source === 'hongguo' ? this.hongguoCount : this.hemaCount;
                
                // åªæœ‰åœ¨ç¬¬ä¸€é¡µä¸”æ²¡æœ‰å†…å®¹æ—¶æ‰æ¸…ç©º
                if (this.searchResults[source].length > 0 && grid.innerHTML.includes('åŠ è½½ä¸­')) {
                    grid.innerHTML = '';
                }
                
                // åªè¿½åŠ æ–°åŠ è½½çš„æ•°æ®
                const startIndex = grid.children.length; // å½“å‰å·²æœ‰å¤šå°‘ä¸ªå…ƒç´ 
                for (let i = startIndex; i < this.searchResults[source].length; i++) {
                    const movie = this.searchResults[source][i];
                    const card = this.createMovieCard(movie, true);
                    grid.appendChild(card);
                }
                
                // æ›´æ–°è®¡æ•°
                if (countElement) countElement.textContent = `å…± ${this.searchResults[source].length} éƒ¨`;
                
                // æ›´æ–°æ€»ç»“æœè®¡æ•°
                const total = this.searchResults.hongguo.length + this.searchResults.hema.length;
                if (this.searchCount) this.searchCount.textContent = `å…± ${total} æ¡ç»“æœ`;
            }

            async loadMoreResults(source) {
                if (source === 'hongguo' && !this.hasMoreHongguo) return;
                if (source === 'hema' && !this.hasMoreHema) return;
                
                const nextPage = Math.floor(this.searchResults[source].length / 10) + 1;
                await this.loadSearchResults(source, nextPage);
            }

            createMovieCard(movie, isSearchResult = false) {
                const card = document.createElement('div');
                card.className = 'movie-card';
                
                // ä¿®å¤ï¼šç¡®ä¿ intro æ˜¯å­—ç¬¦ä¸²
                let introText = movie.intro || movie.title;
                if (typeof introText !== 'string') {
                    introText = movie.title || 'æš‚æ— ç®€ä»‹';
                }
                
                card.innerHTML = `
                    <div class="movie-cover">
                        <img src="${movie.cover}" alt="${movie.title}" 
                             onerror="this.src='image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNSIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+WKoOi9veS4lueVjCk8L3RleHQ+PC9zdmc+';">
                        <div class="favorite-icon ${this.isFavorite(movie) ? 'favorited' : ''}" data-book-id="${movie.book_id}">â­</div>
                    </div>
                    <div class="movie-info">
                        <div class="movie-title">${this.escapeHtml(movie.title)}</div>
                        <div class="movie-meta">${movie.author || 'æœªçŸ¥ä¸»æ¼”'}</div>
                        <div class="movie-intro">${this.escapeHtml(introText)}</div>
                    </div>
                `;
                
                // æ·»åŠ æ”¶è—å›¾æ ‡äº‹ä»¶
                const favoriteIcon = card.querySelector('.favorite-icon');
                favoriteIcon.addEventListener('click', (e) => {
                    e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé¿å…è§¦å‘å¡ç‰‡ç‚¹å‡»
                    this.toggleFavorite(movie);
                    favoriteIcon.classList.toggle('favorited');
                });
                
                card.addEventListener('click', () => {
                    if (isSearchResult) {
                        this.selectMovie(movie);
                    } else {
                        this.selectMovie(movie);
                    }
                });
                return card;
            }

            toggleFavorite(movie) {
                const index = this.favorites.findIndex(f => f.book_id === movie.book_id);
                if (index > -1) {
                    this.favorites.splice(index, 1);
                } else {
                    this.favorites.push(movie);
                }
                localStorage.setItem('favorites', JSON.stringify(this.favorites));
            }

            isFavorite(movie) {
                return this.favorites.some(f => f.book_id === movie.book_id);
            }

            async selectMovie(movie) {
                console.log('æ­£åœ¨é€‰æ‹©ç”µå½±:', movie);
                this.currentBookId = movie.book_id;
                this.addHistory(movie);
                this.displayMovieDetail(movie);
                await this.loadEpisodes(movie.book_id);
                this.showVideoPage();
            }

            displayMovieDetail(movie) {
                if (this.videoTitle) this.videoTitle.textContent = movie.title;
                if (this.videoMeta) {
                    const playCnt = Number(movie.play_cnt) || 0;
                    const typeText = Array.isArray(movie.type) ? movie.type.join(', ') : (movie.type || 'çˆ±æƒ…,åŠ¨ç”»,å¥‡å¹»,å†’é™©');
                    this.videoMeta.textContent = `ç‚¹å‡»é‡ ${this.formatNumber(playCnt)} | ${movie.year || '2025'} ${typeText}`;
                }
                
                // è®¾ç½®é›†æ•°
                if (this.episodeCount) {
                    const episodeCnt = movie.episode_cnt || 1;
                    this.episodeCount.textContent = `æ›´æ–°è‡³${episodeCnt}é›† >`;
                }
            }

            async loadEpisodes(bookId) {
                try {
                  
                   
                    let response;
                    if (this.currentSource === 'hongguo') {
                        response = await fetch(`https://api.cenguigui.cn/api/duanju/api.php?book_id=${bookId}`);
                    } else if (this.currentSource === 'hema') {
                        response = await fetch(`https://api.cenguigui.cn/api/duanju/hema.php?book_id=${bookId}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.code === 200 && Array.isArray(data.data)) {
                     
                        if (this.currentSource === 'hema') {
                            this.episodes = data.data.map(episode => ({
                                ...episode,
                                book_id: data.book_id,
                                book_name: data.book_name
                            }));
                        } else {
                            this.episodes = data.data;
                        }
                        this.displayEpisodes(this.episodes);
                    } else {
                        alert('è·å–å‰§é›†å¤±è´¥: ' + (data.msg || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    alert('è·å–å‰§é›†å¤±è´¥: ' + error.message);
                }
            }

            displayEpisodes(episodes) {
                if (!this.episodesScroll) return;
                this.episodesScroll.innerHTML = '';
                episodes.forEach((episode, index) => {
                    const btn = document.createElement('div');
                    btn.className = 'episode-item';
                    btn.textContent = episode.title;
                    btn.addEventListener('click', () => this.playEpisode(episode.video_id, episode.title, index));
                    this.episodesScroll.appendChild(btn);
                });
                
                // é»˜è®¤æ’­æ”¾ç¬¬ä¸€é›†
                if (episodes.length > 0) {
                    this.playEpisode(episodes[0].video_id, episodes[0].title, 0);
                }
            }

            async playEpisode(videoId, title, index) {
                try {
                    this.currentEpisodeIndex = index;
                   
                 
                    let apiUrl;
                    if (this.currentSource === 'hongguo') {
                        apiUrl = `https://api.cenguigui.cn/api/duanju/api.php?video_id=${videoId}`;
                    } else if (this.currentSource === 'hema') {
                        // æ²³é©¬æ¥å£éœ€è¦ book_id, book_name, video_id
                        const bookId = this.episodes[index]?.book_id;
                        const bookName = this.episodes[index]?.book_name;
                        if (bookId && bookName) {
                            apiUrl = `https://api.cenguigui.cn/api/duanju/hema.php?book_id=${bookId}&book_name=${encodeURIComponent(bookName)}&video_id=${videoId}`;
                        } else {
                            alert('æ’­æ”¾å¤±è´¥: ç¼ºå°‘å¿…è¦å‚æ•°');
                            return;
                        }
                    }
                    
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        const videoUrl = data.data.url;
                        if (this.videoPlayer) {
                            this.videoPlayer.src = videoUrl;
                            this.videoPlayer.load();
                        }
                        
                        // æ›´æ–°é€‰é›†æŒ‰é’®çŠ¶æ€
                        const buttons = this.episodesScroll.querySelectorAll('.episode-item');
                        buttons.forEach((btn, i) => {
                            if (i === index) {
                                btn.classList.add('active');
                            } else {
                                btn.classList.remove('active');
                            }
                        });
                    } else {
                        alert('æ’­æ”¾å¤±è´¥: ' + (data.msg || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    alert('æ’­æ”¾å¤±è´¥: ' + error.message);
                }
            }

            playNextEpisode() {
                if (this.episodes.length === 0) return;
                
                const nextIndex = (this.currentEpisodeIndex + 1) % this.episodes.length;
                const nextEpisode = this.episodes[nextIndex];
                this.playEpisode(nextEpisode.video_id, nextEpisode.title, nextIndex);
            }

            showVideoPage() {
                if (this.mainContent) this.mainContent.style.display = 'none';
                if (this.searchResultsPage) this.searchResultsPage.style.display = 'none';
                if (this.videoPage) this.videoPage.style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            async loadRecommendedContent() {
                try {
                    // éšæœºé€‰æ‹©ä¸€ä¸ªå…³é”®è¯å’Œé¡µç 
                    const keywords = ['çƒ­é—¨', 'æ€»è£', 'æ ¡å›­', 'ç³»ç»Ÿ', 'æ— æ•Œ','ç¥è±ª'];
                    const randomKeyword = keywords[Math.floor(Math.random() * keywords.length)];
                    const randomPage = Math.floor(Math.random() * 7) + 1; // 1~7
                    
                    const response = await fetch(`https://api.cenguigui.cn/api/duanju/api.php?name=${encodeURIComponent(randomKeyword)}&page=${randomPage}`);
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        const movies = data.data.slice(0, 10); 
                        this.displayMoviesGrid(movies, this.recommendedMovies);
                    } else {
                        if (this.recommendedMovies) this.recommendedMovies.innerHTML = '<div class="error">æ¨èå†…å®¹åŠ è½½å¤±è´¥</div>';
                    }
                } catch (error) {
                    if (this.recommendedMovies) this.recommendedMovies.innerHTML = '<div class="error">æ¨èå†…å®¹åŠ è½½å¤±è´¥</div>';
                }
            }

            displayMoviesGrid(movies, container) {
                if (!container) return;
                container.innerHTML = '';
                if (movies.length === 0) {
                    container.innerHTML = '<div class="error">æš‚æ— å†…å®¹</div>';
                    return;
                }
                
                movies.forEach(movie => {
                    const card = this.createMovieCard(movie);
                    container.appendChild(card);
                });
            }

            addHistory(movie) {
                const existingIndex = this.history.findIndex(item => item.book_id === movie.book_id);
                if (existingIndex > -1) {
                    this.history.splice(existingIndex, 1);
                }
                this.history.unshift(movie);
                if (this.history.length > 10) {
                    this.history = this.history.slice(0, 10);
                }
                localStorage.setItem('history', JSON.stringify(this.history));
            }

            displayFavorites() {
                const favoritesContent = document.getElementById('favoritesContent');
                if (!favoritesContent) return;
                if (this.favorites.length === 0) {
                    favoritesContent.innerHTML = 'æš‚æ— æ”¶è—å†…å®¹';
                    return;
                }
                
                favoritesContent.innerHTML = '';
                this.favorites.forEach(item => {
                    const div = document.createElement('div');
                    div.textContent = item.title;
                    div.style.padding = '10px';
                    div.style.borderBottom = '1px solid #eee';
                    div.style.cursor = 'pointer';
                    div.addEventListener('click', () => {
                        this.selectMovie(item);
                        this.closeModal('favorites');
                    });
                    favoritesContent.appendChild(div);
                });
            }

            displayHistory() {
                const historyContent = document.getElementById('historyContent');
                if (!historyContent) return;
                if (this.history.length === 0) {
                    historyContent.innerHTML = 'æš‚æ— å†å²è®°å½•';
                    return;
                }
                
                historyContent.innerHTML = '';
                this.history.forEach(item => {
                    const div = document.createElement('div');
                    div.textContent = item.title;
                    div.style.padding = '10px';
                    div.style.borderBottom = '1px solid #eee';
                    div.style.cursor = 'pointer';
                    div.addEventListener('click', () => {
                        this.selectMovie(item);
                        this.closeModal('history');
                    });
                    historyContent.appendChild(div);
                });
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            formatNumber(num) {
                if (typeof num !== 'number' || isNaN(num)) {
                    return '0';
                }
                if (num >= 10000) {
                    return (num / 10000).toFixed(1) + 'ä¸‡';
                }
                return num.toLocaleString();
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            new ShortFilmSearch();
        });
    </script>
</body>
</html>
