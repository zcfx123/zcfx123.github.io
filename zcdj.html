<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Áü≠ÂâßÁåéÊâã</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            width: 30px; /* Ë∞ÉÊï¥ÂÆΩÂ∫¶ */
            height: 30px; /* Ë∞ÉÊï¥È´òÂ∫¶ */
            margin-right: 10px;
            cursor: pointer;
            object-fit: contain; /* Á°Æ‰øùÂõæÁâáÂÆåÊï¥ÊòæÁ§∫ */
        }

        .search-container {
            flex: 1;
            max-width: 500px;
            margin: 0 15px;
        }

        .search-input {
            width: 100%;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
        }

        .header-icons {
            display: flex;
            gap: 15px;
        }

        .header-icon {
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .carousel {
            width: 100%;
            height: 200px;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .carousel img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .section {
            margin: 30px 0;
        }

        .section-title {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 15px;
        }

        .movies-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* ‰∏ÄË°å3‰∏™ */
            gap: 15px;
        }

        .movie-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease;
            position: relative; /* ‰∏∫Êî∂ËóèÂõæÊ†áÂÆö‰Ωç */
        }

        .movie-card:hover {
            transform: translateY(-2px);
        }

        .movie-cover {
            width: 100%;
            height: 200px; /* Âõ∫ÂÆöÈ´òÂ∫¶Ôºå‰∏éÂç°Áâá‰∏ÄËá¥ */
            object-fit: cover; /* Â°´Êª°ÔºåË£ÅÂâ™ËæπÁºò */
            display: block;
        }

        .movie-info {
            padding: 10px;
        }

        .movie-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .movie-meta {
            color: #777;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .movie-intro {
            color: #999;
            font-size: 0.8rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Êñ∞Â¢ûÔºöÊî∂ËóèÂõæÊ†áÊ†∑Âºè */
        .favorite-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 18px;
            color: #ccc;
            cursor: pointer;
            z-index: 10;
        }

        .favorite-icon.favorited {
            color: #ff6b6b;
        }

        /* ÊêúÁ¥¢ÁªìÊûúÈ°µÈù¢ */
        .search-results-page {
            display: none;
        }

        .search-results-header {
            display: flex;
            align-items: center;
            margin: 20px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .search-results-header h2 {
            margin-right: 15px;
            font-size: 1.1rem;
        }

        .search-results-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        /* Êñ∞Â¢ûÔºöÊêúÁ¥¢ÁªìÊûúÊ†áÁ≠æÈ°µ */
        .search-source-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .search-source-tab {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
        }

        .search-source-tab.active {
            color: #ff6b6b;
            border-bottom-color: #ff6b6b;
        }

        .source-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none; /* ÈªòËÆ§ÈöêËóèÔºåÈÄöËøáJSÊéßÂà∂ÊòæÁ§∫ */
        }

        .source-section.active {
            display: block;
        }

        .source-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .source-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-right: 10px;
        }

        .source-count {
            font-size: 0.8rem;
            color: #777;
        }

        .source-movies-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* ‰∏ÄË°å3‰∏™ */
            gap: 15px;
        }

        /* Êí≠ÊîæÈ°µÈù¢ */
        .video-page {
            display: none;
        }

        .video-player-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto 20px;
            background: black;
            border-radius: 8px;
            overflow: hidden;
        }

        .video-player {
            width: 100%;
            height: 450px;
            background: #000;
        }

        .video-info {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .video-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .video-meta {
            color: #777;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .episodes-list {
            margin: 20px 0;
        }

        .episodes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .episodes-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }

        .episodes-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
            scrollbar-width: thin;
            scrollbar-color: #ccc #f5f5f5;
        }

        .episode-item {
            min-width: 80px;
            padding: 10px 15px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .episode-item:hover {
            background: #eee;
        }

        .episode-item.active {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #777;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .movies-grid,
            .source-movies-grid {
                grid-template-columns: 1fr;
            }

            .video-player {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Â§¥ÈÉ® -->
    <div class="header">
        <img class="logo" id="logo" src="1.png" alt="Logo">
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="ÊêúÁ¥¢Áü≠ÂâßÂêçÁß∞...">
        </div>
        <div class="header-icons">
            <div class="header-icon" id="historyIcon">üïí</div>
            <div class="header-icon" id="downloadIcon">‚≠êÔ∏è</div>
        </div>
    </div>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
    <div class="container" id="mainContent">
        <!-- ËΩÆÊí≠Âõæ -->
        <div class="carousel" id="carousel">
            <img src="IMG_20251004_152412.jpg" alt="ËΩÆÊí≠Âõæ">
        </div>

        <!-- Êé®ËçêÂÜÖÂÆπ -->
        <div class="section">
            <div class="section-title">Êé®Ëçê</div>
            <div class="movies-grid" id="recommendedMovies">
                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>
    </div>

    <!-- ÊêúÁ¥¢ÁªìÊûúÈ°µÈù¢ -->
    <div class="container search-results-page" id="searchResultsPage">
        <div class="search-results-header">
            <h2>ÊêúÁ¥¢ÁªìÊûú</h2>
            <div class="search-results-count" id="searchCount">ÂÖ± 0 Êù°ÁªìÊûú</div>
        </div>

        <!-- ÊêúÁ¥¢ÁªìÊûúÊ†áÁ≠æÈ°µ -->
        <div class="search-source-tabs">
            <div class="search-source-tab active" data-source="hongguo">Á∫¢Êûú</div>
            <div class="search-source-tab" data-source="hema">Ê≤≥È©¨</div>
        </div>

        <div class="search-results-content" id="searchResultsContent">
            <!-- Á∫¢Êûú -->
            <div class="source-section active" id="sourceSectionHongguo">
                <div class="source-header">
                    <div class="source-name">Á∫¢Êûú</div>
                    <div class="source-count" id="hongguoCount">ÂÖ± 0 ÈÉ®</div>
                </div>
                <div class="source-movies-grid" id="hongguoGrid">
                    <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                </div>
            </div>
            <!-- Ê≤≥È©¨ -->
            <div class="source-section" id="sourceSectionHema">
                <div class="source-header">
                    <div class="source-name">Ê≤≥È©¨</div>
                    <div class="source-count" id="hemaCount">ÂÖ± 0 ÈÉ®</div>
                </div>
                <div class="source-movies-grid" id="hemaGrid">
                    <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ËßÜÈ¢ëÊí≠ÊîæÈ°µÈù¢ -->
    <div class="container video-page" id="videoPage">
        <div class="video-player-container">
            <video class="video-player" id="videoPlayer" controls preload="metadata">
                ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËßÜÈ¢ëÊí≠Êîæ
            </video>
        </div>

        <div class="video-info">
            <h1 class="video-title" id="videoTitle">ËßÜÈ¢ëÊ†áÈ¢ò</h1>
            <div class="video-meta" id="videoMeta">ÁÇπÂáªÈáè 0 | 2025 Áà±ÊÉÖ,Âä®Áîª,Â•áÂπª,ÂÜíÈô©</div>
        </div>

        <div class="episodes-list">
            <div class="episodes-header">
                <div class="episodes-title">ÈÄâÈõÜ</div>
                <div class="episodes-more" id="episodeCount">Êõ¥Êñ∞Ëá≥1ÈõÜ ></div>
            </div>
            <div class="episodes-scroll" id="episodesScroll">
                <!-- ÂâßÈõÜÂàóË°®‰ºöÂä®ÊÄÅÊèíÂÖ•Âà∞ËøôÈáå -->
            </div>
        </div>
    </div>

    <!-- ÂÖ≥‰∫éÊàëÂºπÁ™ó -->
    <div class="modal" id="aboutModal">
        <div class="modal-content">
            <span class="modal-close" id="closeAboutModal">&times;</span>
            <h2>ÂÖ≥‰∫éÊàë</h2>
            <p>ÊÑüË∞¢‰ΩøÁî®Áî±zcÂºÄÂèëÁöÑÁü≠ÂâßÁåéÊâãÂ∫îÁî®ÔºÅ</p>
            <p>Êèê‰æõÊµ∑Èáè‰ºòË¥®Áü≠ÂâßËµÑÊ∫êÔºåÊîØÊåÅÁï™ËåÑ/Ë•øÁìú/Á∫¢Êûú/ËõãËä±/Â∏∏ËØª/ÊÇüÁ©∫/Ê≤≥È©¨/ÁπÅËä±/ÁÇπ‰ºó Ëøô‰∫õÂπ≥Âè∞</p>
            <p>ÊåÅÁª≠Êõ¥Êñ∞ÊúÄÊñ∞Áü≠ÂâßÊó†ÂπøÂëäÂÜÖÂÆπÔºÅ‰∏∫‰Ω†Â∏¶Êù•ÊúÄ‰Ω≥ËßÇÁúã‰ΩìÈ™åÔºÅ</p>
        </div>
    </div>

    <!-- Êî∂ËóèÂºπÁ™ó -->
    <div class="modal" id="favoritesModal">
        <div class="modal-content">
            <span class="modal-close" id="closeFavoritesModal">&times;</span>
            <h2>Êî∂ËóèÂàóË°®</h2>
            <div id="favoritesContent">ÊöÇÊó†Êî∂ËóèÂÜÖÂÆπ</div>
        </div>
    </div>

    <!-- ÂéÜÂè≤ËßÇÁúãÂºπÁ™ó -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <span class="modal-close" id="closeHistoryModal">&times;</span>
            <h2>ÂéÜÂè≤ËßÇÁúã</h2>
            <div id="historyContent">ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</div>
        </div>
    </div>

    <script>
        class ShortFilmSearch {
            constructor() {
                this.currentPage = 1;
                this.currentKeyword = '';
                this.currentBookId = '';
                this.currentVideoId = '';
                this.searchResults = { hongguo: [], hema: [] };
                this.favorites = JSON.parse(localStorage.getItem('favorites')) || [];
                this.history = JSON.parse(localStorage.getItem('history')) || [];
                this.currentEpisodeIndex = 0;
                this.episodes = [];
                this.currentQuality = '1080P';
                this.autoPlay = true;
                
              
                this.loadingHongguo = false;
                this.loadingHema = false;
                this.hasMoreHongguo = true;
                this.hasMoreHema = true;
                
             
                this.currentSource = 'hongguo';
                
                this.initializeElements();
                this.bindEvents();
                this.loadRecommendedContent();
            }

            initializeElements() {
                this.logo = document.getElementById('logo');
                this.searchInput = document.getElementById('searchInput');
                this.historyIcon = document.getElementById('historyIcon');
                this.downloadIcon = document.getElementById('downloadIcon');
                this.carousel = document.getElementById('carousel');
                this.recommendedMovies = document.getElementById('recommendedMovies');
                
                this.mainContent = document.getElementById('mainContent');
                this.searchResultsPage = document.getElementById('searchResultsPage');
                this.videoPage = document.getElementById('videoPage');
                
                this.searchResultsContent = document.getElementById('searchResultsContent');
                this.searchCount = document.getElementById('searchCount');
                
           
                this.searchSourceTabs = document.querySelectorAll('.search-source-tab');
                this.sourceSectionHongguo = document.getElementById('sourceSectionHongguo');
                this.sourceSectionHema = document.getElementById('sourceSectionHema');
                this.hongguoGrid = document.getElementById('hongguoGrid');
                this.hemaGrid = document.getElementById('hemaGrid');
                this.hongguoCount = document.getElementById('hongguoCount');
                this.hemaCount = document.getElementById('hemaCount');
                
                this.videoPlayer = document.getElementById('videoPlayer');
                this.videoTitle = document.getElementById('videoTitle');
                this.videoMeta = document.getElementById('videoMeta');
                this.episodesScroll = document.getElementById('episodesScroll');
                this.episodeCount = document.getElementById('episodeCount');
                
               
                this.aboutModal = document.getElementById('aboutModal');
                this.closeAboutModal = document.getElementById('closeAboutModal');
                
                this.favoritesModal = document.getElementById('favoritesModal');
                this.historyModal = document.getElementById('historyModal');
                this.closeFavoritesModal = document.getElementById('closeFavoritesModal');
                this.closeHistoryModal = document.getElementById('closeHistoryModal');
            }

            bindEvents() {
               
                if (this.logo) this.logo.addEventListener('click', function() { this.openModal('about'); }.bind(this));
                if (this.searchInput) this.searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleSearch();
                });
                if (this.historyIcon) this.historyIcon.addEventListener('click', () => this.openModal('history'));
                if (this.downloadIcon) this.downloadIcon.addEventListener('click', () => this.openModal('favorites'));
                
                // ÊêúÁ¥¢ÁªìÊûúÊ†áÁ≠æÈ°µÂàáÊç¢‰∫ã‰ª∂
                this.searchSourceTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.searchSourceTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        const source = tab.dataset.source;
                        this.currentSource = source; // Êõ¥Êñ∞ÂΩìÂâçÊé•Âè£
                        this.showSourceTab(source);
                    });
                });
                
                // ÂÖ≥‰∫éÊàëÂºπÁ™óÂÖ≥Èó≠‰∫ã‰ª∂
                if (this.closeAboutModal) this.closeAboutModal.addEventListener('click', () => this.closeModal('about'));
                
                // ÊªöÂä®Âä†ËΩΩ‰∫ã‰ª∂
                window.addEventListener('scroll', this.handleScroll.bind(this));
                
                // ËßÜÈ¢ëÊí≠ÊîæÈîôËØØÂ§ÑÁêÜ
                if (this.videoPlayer) this.videoPlayer.addEventListener('error', (e) => {
                    console.error('ËßÜÈ¢ëÊí≠ÊîæÈîôËØØ:', e);
                    alert('ËßÜÈ¢ëÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Â∞ùËØïÂà∑Êñ∞È°µÈù¢ÊàñÊç¢Ê∫ê');
                });
                
                // ËßÜÈ¢ëÊí≠ÊîæÂÆåÊàê‰∫ã‰ª∂ - Áî®‰∫éËá™Âä®ËøûÊí≠
                if (this.videoPlayer) this.videoPlayer.addEventListener('ended', () => {
                    if (this.autoPlay && this.episodes.length > 0) {
                        this.playNextEpisode();
                    }
                });
                
                // ÂºπÁ™óÂÖ≥Èó≠‰∫ã‰ª∂
                if (this.closeFavoritesModal) this.closeFavoritesModal.addEventListener('click', () => this.closeModal('favorites'));
                if (this.closeHistoryModal) this.closeHistoryModal.addEventListener('click', () => this.closeModal('history'));
            }

            openModal(type) {
                switch(type) {
                    case 'about':
                        if (this.aboutModal) this.aboutModal.style.display = 'flex';
                        break;
                    case 'favorites':
                        this.displayFavorites();
                        if (this.favoritesModal) this.favoritesModal.style.display = 'flex';
                        break;
                    case 'history':
                        this.displayHistory();
                        if (this.historyModal) this.historyModal.style.display = 'flex';
                        break;
                }
            }

            closeModal(type) {
                switch(type) {
                    case 'about':
                        if (this.aboutModal) this.aboutModal.style.display = 'none';
                        break;
                    case 'favorites':
                        if (this.favoritesModal) this.favoritesModal.style.display = 'none';
                        break;
                    case 'history':
                        if (this.historyModal) this.historyModal.style.display = 'none';
                        break;
                }
            }

            // ÊªöÂä®Âä†ËΩΩÂ§ÑÁêÜÂáΩÊï∞
            handleScroll() {
                if (this.searchResultsPage.style.display !== 'block') return; // Âè™Âú®ÊêúÁ¥¢ÁªìÊûúÈ°µÊâßË°å

                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const windowHeight = window.innerHeight;
                const documentHeight = document.documentElement.scrollHeight;

                if (scrollTop + windowHeight >= documentHeight - 100) { // Ë∑ùÁ¶ªÂ∫ïÈÉ®100pxÊó∂Ëß¶Âèë
                    const activeSource = this.currentSource; // ‰ΩøÁî®ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊé•Âè£
                    if (activeSource === 'hongguo' && this.hasMoreHongguo && !this.loadingHongguo) {
                        this.loadMoreResults('hongguo');
                    } else if (activeSource === 'hema' && this.hasMoreHema && !this.loadingHema) {
                        this.loadMoreResults('hema');
                    }
                }
            }

            getActiveSource() {
                // ‰ºòÂÖà‰ΩøÁî® this.currentSource
                return this.currentSource;
            }

            showSourceTab(source) {
                if (source === 'hongguo') {
                    this.sourceSectionHongguo.classList.add('active');
                    this.sourceSectionHema.classList.remove('active');
                } else if (source === 'hema') {
                    this.sourceSectionHema.classList.add('active');
                    this.sourceSectionHongguo.classList.remove('active');
                }
                this.currentSource = source; // Êõ¥Êñ∞ÂΩìÂâçÊé•Âè£
            }

            async handleSearch() {
                const keyword = this.searchInput?.value.trim();
                if (!keyword) return;
                
                this.currentKeyword = keyword;
                this.searchResults = { hongguo: [], hema: [] };
                this.currentPage = 1; // ÈáçÁΩÆÈ°µÁ†Å
                this.hasMoreHongguo = true;
                this.hasMoreHema = true;
                this.loadingHongguo = false;
                this.loadingHema = false;
                
                // ÊòæÁ§∫Âä†ËΩΩ‰∏≠
                this.hongguoGrid.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';
                this.hemaGrid.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';
                
                // ÂêåÊó∂ËØ∑Ê±Ç‰∏§‰∏™Êé•Âè£ÁöÑÁ¨¨‰∏ÄÈ°µ
                await Promise.all([
                    this.loadSearchResults('hongguo', 1),
                    this.loadSearchResults('hema', 1)
                ]);
                
                // ÂàáÊç¢Âà∞ÊêúÁ¥¢ÁªìÊûúÈ°µÈù¢
                if (this.mainContent) this.mainContent.style.display = 'none';
                if (this.searchResultsPage) this.searchResultsPage.style.display = 'block';
                if (this.videoPage) this.videoPage.style.display = 'none';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            async loadSearchResults(source, page) {
                if (source === 'hongguo') {
                    this.loadingHongguo = true;
                } else if (source === 'hema') {
                    this.loadingHema = true;
                }

                try {
                
                    let apiUrl;
                    if (source === 'hongguo') {
                        apiUrl = `https://api.cenguigui.cn/api/duanju/api.php?name=${encodeURIComponent(this.currentKeyword)}&page=${page}`;
                    } else if (source === 'hema') {
                        apiUrl = `https://api.cenguigui.cn/api/duanju/hema.php?name=${encodeURIComponent(this.currentKeyword)}&page=${page}`;
                    }

                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        // ÂéªÈáçÈÄªËæë
                        const newResults = data.data.filter(newItem => 
                            !this.searchResults[source].some(existingItem => existingItem.book_id === newItem.book_id)
                        );
                        this.searchResults[source] = [...this.searchResults[source], ...newResults];
                        
                        if (newResults.length === 0) { // Â¶ÇÊûúÊ≤°ÊúâÊñ∞Êï∞ÊçÆÔºåËØ¥ÊòéÊ≤°ÊúâÊõ¥Â§ö‰∫Ü
                            if (source === 'hongguo') this.hasMoreHongguo = false;
                            if (source === 'hema') this.hasMoreHema = false;
                        }
                        this.displaySearchResults(source);
                    } else {
                        if (source === 'hongguo') this.hasMoreHongguo = false;
                        if (source === 'hema') this.hasMoreHema = false;
                    }
                } catch (error) {
                    console.error(`Âä†ËΩΩ${source}ÁªìÊûúÂ§±Ë¥•:`, error);
                    if (source === 'hongguo') this.hasMoreHongguo = false;
                    if (source === 'hema') this.hasMoreHema = false;
                } finally {
                    if (source === 'hongguo') {
                        this.loadingHongguo = false;
                    } else if (source === 'hema') {
                        this.loadingHema = false;
                    }
                }
            }

            displaySearchResults(source) {
                const grid = source === 'hongguo' ? this.hongguoGrid : this.hemaGrid;
                const countElement = source === 'hongguo' ? this.hongguoCount : this.hemaCount;
                
                // Âè™ÊúâÂú®Á¨¨‰∏ÄÈ°µ‰∏îÊ≤°ÊúâÂÜÖÂÆπÊó∂ÊâçÊ∏ÖÁ©∫
                if (this.searchResults[source].length > 0 && grid.innerHTML.includes('Âä†ËΩΩ‰∏≠')) {
                    grid.innerHTML = '';
                }
                
                // Âè™ËøΩÂä†Êñ∞Âä†ËΩΩÁöÑÊï∞ÊçÆ
                const startIndex = grid.children.length; // ÂΩìÂâçÂ∑≤ÊúâÂ§öÂ∞ë‰∏™ÂÖÉÁ¥†
                for (let i = startIndex; i < this.searchResults[source].length; i++) {
                    const movie = this.searchResults[source][i];
                    const card = this.createMovieCard(movie, true);
                    grid.appendChild(card);
                }
                
                // Êõ¥Êñ∞ËÆ°Êï∞
                if (countElement) countElement.textContent = `ÂÖ± ${this.searchResults[source].length} ÈÉ®`;
                
                // Êõ¥Êñ∞ÊÄªÁªìÊûúËÆ°Êï∞
                const total = this.searchResults.hongguo.length + this.searchResults.hema.length;
                if (this.searchCount) this.searchCount.textContent = `ÂÖ± ${total} Êù°ÁªìÊûú`;
            }

            async loadMoreResults(source) {
                if (source === 'hongguo' && !this.hasMoreHongguo) return;
                if (source === 'hema' && !this.hasMoreHema) return;
                
                const nextPage = Math.floor(this.searchResults[source].length / 10) + 1;
                await this.loadSearchResults(source, nextPage);
            }

            createMovieCard(movie, isSearchResult = false) {
                const card = document.createElement('div');
                card.className = 'movie-card';
                
                // ‰øÆÂ§çÔºöÁ°Æ‰øù intro ÊòØÂ≠óÁ¨¶‰∏≤
                let introText = movie.intro || movie.title;
                if (typeof introText !== 'string') {
                    introText = movie.title || 'ÊöÇÊó†ÁÆÄ‰ªã';
                }
                
                card.innerHTML = `
                    <div class="movie-cover">
                        <img src="${movie.cover}" alt="${movie.title}" 
                             onerror="this.src='image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNSIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+WKoOi9veS4lueVjCk8L3RleHQ+PC9zdmc+';">
                        <div class="favorite-icon ${this.isFavorite(movie) ? 'favorited' : ''}" data-book-id="${movie.book_id}">‚≠ê</div>
                    </div>
                    <div class="movie-info">
                        <div class="movie-title">${this.escapeHtml(movie.title)}</div>
                        <div class="movie-meta">${movie.author || 'Êú™Áü•‰∏ªÊºî'}</div>
                        <div class="movie-intro">${this.escapeHtml(introText)}</div>
                    </div>
                `;
                
                // Ê∑ªÂä†Êî∂ËóèÂõæÊ†á‰∫ã‰ª∂
                const favoriteIcon = card.querySelector('.favorite-icon');
                favoriteIcon.addEventListener('click', (e) => {
                    e.stopPropagation(); // ÈòªÊ≠¢ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶ÂèëÂç°ÁâáÁÇπÂáª
                    this.toggleFavorite(movie);
                    favoriteIcon.classList.toggle('favorited');
                });
                
                card.addEventListener('click', () => {
                    if (isSearchResult) {
                        this.selectMovie(movie);
                    } else {
                        this.selectMovie(movie);
                    }
                });
                return card;
            }

            toggleFavorite(movie) {
                const index = this.favorites.findIndex(f => f.book_id === movie.book_id);
                if (index > -1) {
                    this.favorites.splice(index, 1);
                } else {
                    this.favorites.push(movie);
                }
                localStorage.setItem('favorites', JSON.stringify(this.favorites));
            }

            isFavorite(movie) {
                return this.favorites.some(f => f.book_id === movie.book_id);
            }

            async selectMovie(movie) {
                console.log('Ê≠£Âú®ÈÄâÊã©ÁîµÂΩ±:', movie);
                this.currentBookId = movie.book_id;
                this.addHistory(movie);
                this.displayMovieDetail(movie);
                await this.loadEpisodes(movie.book_id);
                this.showVideoPage();
            }

            displayMovieDetail(movie) {
                if (this.videoTitle) this.videoTitle.textContent = movie.title;
                if (this.videoMeta) {
                    const playCnt = Number(movie.play_cnt) || 0;
                    const typeText = Array.isArray(movie.type) ? movie.type.join(', ') : (movie.type || 'Áà±ÊÉÖ,Âä®Áîª,Â•áÂπª,ÂÜíÈô©');
                    this.videoMeta.textContent = `ÁÇπÂáªÈáè ${this.formatNumber(playCnt)} | ${movie.year || '2025'} ${typeText}`;
                }
                
                // ËÆæÁΩÆÈõÜÊï∞
                if (this.episodeCount) {
                    const episodeCnt = movie.episode_cnt || 1;
                    this.episodeCount.textContent = `Êõ¥Êñ∞Ëá≥${episodeCnt}ÈõÜ >`;
                }
            }

            async loadEpisodes(bookId) {
                try {
                  
                   
                    let response;
                    if (this.currentSource === 'hongguo') {
                        response = await fetch(`https://api.cenguigui.cn/api/duanju/api.php?book_id=${bookId}`);
                    } else if (this.currentSource === 'hema') {
                        response = await fetch(`https://api.cenguigui.cn/api/duanju/hema.php?book_id=${bookId}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.code === 200 && Array.isArray(data.data)) {
                     
                        if (this.currentSource === 'hema') {
                            this.episodes = data.data.map(episode => ({
                                ...episode,
                                book_id: data.book_id,
                                book_name: data.book_name
                            }));
                        } else {
                            this.episodes = data.data;
                        }
                        this.displayEpisodes(this.episodes);
                    } else {
                        alert('Ëé∑ÂèñÂâßÈõÜÂ§±Ë¥•: ' + (data.msg || 'Êú™Áü•ÈîôËØØ'));
                    }
                } catch (error) {
                    alert('Ëé∑ÂèñÂâßÈõÜÂ§±Ë¥•: ' + error.message);
                }
            }

            displayEpisodes(episodes) {
                if (!this.episodesScroll) return;
                this.episodesScroll.innerHTML = '';
                episodes.forEach((episode, index) => {
                    const btn = document.createElement('div');
                    btn.className = 'episode-item';
                    btn.textContent = episode.title;
                    btn.addEventListener('click', () => this.playEpisode(episode.video_id, episode.title, index));
                    this.episodesScroll.appendChild(btn);
                });
                
                // ÈªòËÆ§Êí≠ÊîæÁ¨¨‰∏ÄÈõÜ
                if (episodes.length > 0) {
                    this.playEpisode(episodes[0].video_id, episodes[0].title, 0);
                }
            }

            async playEpisode(videoId, title, index) {
                try {
                    this.currentEpisodeIndex = index;
                   
                 
                    let apiUrl;
                    if (this.currentSource === 'hongguo') {
                        apiUrl = `https://api.cenguigui.cn/api/duanju/api.php?video_id=${videoId}`;
                    } else if (this.currentSource === 'hema') {
                        // Ê≤≥È©¨Êé•Âè£ÈúÄË¶Å book_id, book_name, video_id
                        const bookId = this.episodes[index]?.book_id;
                        const bookName = this.episodes[index]?.book_name;
                        if (bookId && bookName) {
                            apiUrl = `https://api.cenguigui.cn/api/duanju/hema.php?book_id=${bookId}&book_name=${encodeURIComponent(bookName)}&video_id=${videoId}`;
                        } else {
                            alert('Êí≠ÊîæÂ§±Ë¥•: Áº∫Â∞ëÂøÖË¶ÅÂèÇÊï∞');
                            return;
                        }
                    }
                    
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        const videoUrl = data.data.url;
                        if (this.videoPlayer) {
                            this.videoPlayer.src = videoUrl;
                            this.videoPlayer.load();
                        }
                        
                        // Êõ¥Êñ∞ÈÄâÈõÜÊåâÈíÆÁä∂ÊÄÅ
                        const buttons = this.episodesScroll.querySelectorAll('.episode-item');
                        buttons.forEach((btn, i) => {
                            if (i === index) {
                                btn.classList.add('active');
                            } else {
                                btn.classList.remove('active');
                            }
                        });
                    } else {
                        alert('Êí≠ÊîæÂ§±Ë¥•: ' + (data.msg || 'Êú™Áü•ÈîôËØØ'));
                    }
                } catch (error) {
                    alert('Êí≠ÊîæÂ§±Ë¥•: ' + error.message);
                }
            }

            playNextEpisode() {
                if (this.episodes.length === 0) return;
                
                const nextIndex = (this.currentEpisodeIndex + 1) % this.episodes.length;
                const nextEpisode = this.episodes[nextIndex];
                this.playEpisode(nextEpisode.video_id, nextEpisode.title, nextIndex);
            }

            showVideoPage() {
                if (this.mainContent) this.mainContent.style.display = 'none';
                if (this.searchResultsPage) this.searchResultsPage.style.display = 'none';
                if (this.videoPage) this.videoPage.style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            async loadRecommendedContent() {
                try {
                    // ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™ÂÖ≥ÈîÆËØçÂíåÈ°µÁ†Å
                    const keywords = ['ÁÉ≠Èó®', 'ÊÄªË£Å', 'Ê†°Âõ≠', 'Á≥ªÁªü', 'Êó†Êïå','Á•ûË±™'];
                    const randomKeyword = keywords[Math.floor(Math.random() * keywords.length)];
                    const randomPage = Math.floor(Math.random() * 7) + 1; // 1~7
                    
                    const response = await fetch(`https://api.cenguigui.cn/api/duanju/api.php?name=${encodeURIComponent(randomKeyword)}&page=${randomPage}`);
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        const movies = data.data.slice(0, 10); 
                        this.displayMoviesGrid(movies, this.recommendedMovies);
                    } else {
                        if (this.recommendedMovies) this.recommendedMovies.innerHTML = '<div class="error">Êé®ËçêÂÜÖÂÆπÂä†ËΩΩÂ§±Ë¥•</div>';
                    }
                } catch (error) {
                    if (this.recommendedMovies) this.recommendedMovies.innerHTML = '<div class="error">Êé®ËçêÂÜÖÂÆπÂä†ËΩΩÂ§±Ë¥•</div>';
                }
            }

            displayMoviesGrid(movies, container) {
                if (!container) return;
                container.innerHTML = '';
                if (movies.length === 0) {
                    container.innerHTML = '<div class="error">ÊöÇÊó†ÂÜÖÂÆπ</div>';
                    return;
                }
                
                movies.forEach(movie => {
                    const card = this.createMovieCard(movie);
                    container.appendChild(card);
                });
            }

            addHistory(movie) {
                const existingIndex = this.history.findIndex(item => item.book_id === movie.book_id);
                if (existingIndex > -1) {
                    this.history.splice(existingIndex, 1);
                }
                this.history.unshift(movie);
                if (this.history.length > 10) {
                    this.history = this.history.slice(0, 10);
                }
                localStorage.setItem('history', JSON.stringify(this.history));
            }

            displayFavorites() {
                const favoritesContent = document.getElementById('favoritesContent');
                if (!favoritesContent) return;
                if (this.favorites.length === 0) {
                    favoritesContent.innerHTML = 'ÊöÇÊó†Êî∂ËóèÂÜÖÂÆπ';
                    return;
                }
                
                favoritesContent.innerHTML = '';
                this.favorites.forEach(item => {
                    const div = document.createElement('div');
                    div.textContent = item.title;
                    div.style.padding = '10px';
                    div.style.borderBottom = '1px solid #eee';
                    div.style.cursor = 'pointer';
                    div.addEventListener('click', () => {
                        this.selectMovie(item);
                        this.closeModal('favorites');
                    });
                    favoritesContent.appendChild(div);
                });
            }

            displayHistory() {
                const historyContent = document.getElementById('historyContent');
                if (!historyContent) return;
                if (this.history.length === 0) {
                    historyContent.innerHTML = 'ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï';
                    return;
                }
                
                historyContent.innerHTML = '';
                this.history.forEach(item => {
                    const div = document.createElement('div');
                    div.textContent = item.title;
                    div.style.padding = '10px';
                    div.style.borderBottom = '1px solid #eee';
                    div.style.cursor = 'pointer';
                    div.addEventListener('click', () => {
                        this.selectMovie(item);
                        this.closeModal('history');
                    });
                    historyContent.appendChild(div);
                });
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            formatNumber(num) {
                if (typeof num !== 'number' || isNaN(num)) {
                    return '0';
                }
                if (num >= 10000) {
                    return (num / 10000).toFixed(1) + '‰∏á';
                }
                return num.toLocaleString();
            }
        }

        // ÂàùÂßãÂåñÂ∫îÁî®
        document.addEventListener('DOMContentLoaded', () => {
            new ShortFilmSearch();
        });
    </script>
</body>
</html>
